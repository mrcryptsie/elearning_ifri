{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title }} - IFRI{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    .lesson-page { font-family: 'Montserrat', sans-serif; background-color: #f8f9fa; }
    .markdown-content { line-height: 1.8; color: #2d3436; font-size: 1.1rem; }
    .markdown-content h1, .markdown-content h2, .markdown-content h3 { color: #0057A8; font-weight: 700; margin-top: 2rem; }
    .markdown-content table { width: 100%; margin-bottom: 1rem; border-collapse: collapse; background: white; }
    .markdown-content table th, .markdown-content table td { padding: 12px; border: 1px solid #dee2e6; }
    .markdown-content blockquote { border-left: 5px solid #0057A8; padding-left: 20px; font-style: italic; color: #636e72; background: #F0F7FF; padding: 15px; border-radius: 0 10px 10px 0; }
    .pdf-container { border: 1px solid #dee2e6; border-radius: 12px; background: #f1f1f1; }
    
    .quiz-card-mini {
        background: #fff;
        border-radius: 15px;
        border: 1.5px solid #eee;
        transition: all 0.3s ease;
    }
    .quiz-card-mini:hover { border-color: #0057A8; transform: translateY(-2px); }
    
    /* Animation pour le bouton de succès */
    .btn-complete {
        background: linear-gradient(45deg, #0057A8, #007BEF);
        transition: all 0.3s ease;
    }
    .btn-complete:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
</style>

<div class="container py-5 lesson-page">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb bg-transparent p-0">
                    <li class="breadcrumb-item"><a href="{% url 'course_content' lesson.course.id %}" class="text-success text-decoration-none">Sommaire</a></li>
                    <li class="breadcrumb-item active fw-bold text-dark">{{ lesson.course.name }}</li>
                </ol>
            </nav>

            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5">
                <div class="p-5 text-white" style="background: linear-gradient(135deg, #0057A8 0%, #007BEF 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="fw-bold mb-1">{{ lesson.title }}</h1>
                            <span class="badge bg-white text-success rounded-pill px-3">Module de formation</span>
                        </div>
                        <i class="fas fa-book-reader fa-3x opacity-25"></i>
                    </div>
                </div>

                <div class="card-body p-4 p-md-5 bg-white">
                    {% if content_html %}
                    <div class="markdown-content mb-5">
                        {{ content_html|safe }}
                    </div>
                    {% endif %}

                    {% if lesson.pdf_file %}
                    <div class="pdf-section mt-5 pt-5 border-top text-center">
                        <div class="d-flex align-items-center justify-content-center mb-4 text-start">
                            <i class="fas fa-file-pdf fa-2x text-danger me-3"></i>
                            <div>
                                <h4 class="fw-bold mb-0">Support de cours PDF</h4>
                                <p class="text-muted small mb-0">Visionnez ou téléchargez le document officiel.</p>
                            </div>
                        </div>
                        <div class="pdf-container shadow-sm mb-4" style="height: 700px; overflow: hidden; border-radius: 15px;">
                            <embed src="{{ lesson.pdf_file.url }}" type="application/pdf" width="100%" height="100%">
                        </div>
                        <a href="{{ lesson.pdf_file.url }}" download class="btn btn-outline-success rounded-pill px-5 py-2 shadow-sm fw-bold">
                            <i class="fas fa-download me-2"></i> Télécharger le PDF
                        </a>
                    </div>
                    {% endif %}
                </div>

                {% if lesson.quizzes.exists %}
                <div class="card-body bg-light-subtle border-top p-4 p-md-5">
                    <h4 class="fw-bold mb-4 text-dark"><i class="fas fa-vial text-primary me-2"></i>Évaluations de ce module</h4>
                    <div class="row g-3">
                        {% for quiz in lesson.quizzes.all %}
                        <div class="col-md-6">
                            <div class="quiz-card-mini p-4 shadow-sm h-100 d-flex justify-content-between align-items-center bg-white">
                                <div>
                                    <h6 class="fw-bold mb-1">{{ quiz.title }}</h6>
                                    <small class="text-muted"><i class="fas fa-clock me-1"></i>{{ quiz.time_limit_mins }} mins</small>
                                </div>
                                <div>
                                    {% if quiz.id in passed_quiz_ids %}
                                        <span class="badge bg-success-subtle text-success rounded-pill p-2 px-3 fw-bold">
                                            <i class="fas fa-check-circle me-1"></i> Validé
                                        </span>
                                    {% else %}
                                        <a href="{% url 'take_quiz' quiz.id %}" class="btn btn-primary btn-sm rounded-pill px-4 shadow-sm fw-bold">
                                            Lancer <i class="fas fa-play ms-1" style="font-size: 0.7rem;"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="card-footer bg-light p-4 border-0 d-flex justify-content-between align-items-center">
                    <a href="{% url 'course_content' lesson.course.id %}" class="btn btn-link text-secondary text-decoration-none small fw-bold">
                        <i class="fas fa-chevron-left me-1"></i> Retour au sommaire
                    </a>
                    
                    {% if lesson.id in completed_lesson_ids %}
                        <button class="btn btn-outline-success rounded-pill px-5 py-2 fw-bold disabled border-2">
                            <i class="fas fa-check-double me-2"></i> Module déjà validé
                        </button>
                    {% else %}
                        <a href="{% url 'complete_lesson' lesson.id %}" class="btn btn-success btn-complete rounded-pill px-5 py-2 fw-bold shadow text-white border-0">
                            <i class="fas fa-check-circle me-2"></i> Valider et continuer
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}